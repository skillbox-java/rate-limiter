# RateLimiter

> –ü—Ä–æ–µ–∫—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Ç–µ—Å—Ç–æ–≤ –∫ Spring Boot
–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é.

–°–µ—Ä–≤–∏—Å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã API-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–ª—é—á—É –∫–ª–∏–µ–Ω—Ç–∞.\

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
rate-limiter/
‚îú‚îÄ‚îÄ app/ # –≥–ª–∞–≤–Ω—ã–π Spring Boot-–º–æ–¥—É–ª—å
‚îú‚îÄ‚îÄ domain/ # –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îú‚îÄ‚îÄ persistence/ # JPA-—Å—É—â–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
‚îú‚îÄ‚îÄ api/ # REST-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ DTO
‚îú‚îÄ‚îÄ gradle/ # Gradle Wrapper
‚îú‚îÄ‚îÄ gradlew* # Unix-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ gradlew.bat* # Windows-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏
‚îî‚îÄ‚îÄ docker-compose.yml # —Å–±–æ—Ä–∫–∞ PostgreSQL –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è docker
```

| –°–ª–æ–π            | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å                               | –ü—Ä–∏–º–µ—Ä—ã                            |
|-----------------|-----------------------------------------------|------------------------------------|
| `domain/`       | –ß–∏—Å—Ç–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞                          | –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, record-–∫–ª–∞—Å—Å—ã, —Å–µ—Ä–≤–∏—Å—ã |
| `application/`  | –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è use case-–æ–≤ (—Ñ–∞—Å–∞–¥—ã, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è) | –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è `RateLimiterService` |
| `persistence/`  | –†–∞–±–æ—Ç–∞ —Å –ë–î, JPA-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏                  | `ClientAppRepository`, `Entity`    |
| `api/`          | REST-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å                                | –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, DTO                   |

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- Java 21
- Spring Boot 3.2.5
- Gradle 8.13 (Wrapper)
- Spring Data JPA
- Liquibase (–º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–¥)
- H2 Database (in-memory, –ø—Ä–æ—Ñ–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- PostgreSQL + Docker Compose (–ø—Ä–æ—Ñ–∏–ª—å `docker`)

## ‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π **JDK 21**
- **Docker 20.10+** (–¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è `docker`)
- –ü–æ—Ä—Ç **8080** —Å–≤–æ–±–æ–¥–µ–Ω –¥–ª—è HTTP
- –ü–æ—Ä—Ç **5432** —Å–≤–æ–±–æ–¥–µ–Ω –¥–ª—è PostgreSQL (–ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ Docker-—Å–µ—Ä–≤–∏—Å–∞)

## üöÄ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ—Ä–≤–∏—Å

1. **–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç** –∫–ª–∏–µ–Ω—Ç–æ–≤ (ClientApp) —Å API-–∫–ª—é—á–∞–º–∏.
2. –•—Ä–∞–Ω–∏—Ç **–ø—Ä–∞–≤–∏–ª–∞** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (RateLimitRule): –º–∞–∫—Å. –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –æ–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏.
3. –ü—Ä–∏ **POST /api/words** —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `X-API-Key` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç –ª–∏–º–∏—Ç:
    - –ï—Å–ª–∏ **OK**, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `200 OK` —Å `{ allowed: true }`.
    - –ï—Å–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `429 TOO MANY REQUESTS` —Å `{ allowed: false, reason: "Limit exceeded" }`.
4. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (RequestLog) –∏ —Å—á–∏—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –æ–∫–Ω–æ.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

`rate.rules.default.maxRequests` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∑–∞ –æ–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏. –¶–µ–ª–æ–µ —á–∏—Å–ª–æ
`rate.rules.default.timeWindow` - –û–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ª–∏–º–∏—Ç–∞. –°—Ç—Ä–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [PnDTnHnMn.nS](https://docs.oracle.com/javase/8/docs/api/java/time/Duration.html#parse-java.lang.CharSequence-)

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫

### 1. –õ–æ–∫–∞–ª—å–Ω–æ (H2, –ø—Ä–æ—Ñ–∏–ª—å –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é)

```bash
# Unix/macOS/Linux
./gradlew clean :app:bootRun
```

```shell
# Windows (PowerShell –∏–ª–∏ cmd)
.\gradlew.bat clean :app:bootRun
```

* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:8080
* H2-–∫–æ–Ω—Å–æ–ª—å: http://localhost:8080/h2-console
  * JDBC URL: `jdbc:h2:mem:ratelimiter` 
  * User: `sa`, –ø–∞—Ä–æ–ª—å –ø—É—Å—Ç–æ–π

### 2. –ß–µ—Ä–µ–∑ Docker Compose (PostgreSQL, –ø—Ä–æ—Ñ–∏–ª—å docker)

```bash
# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
docker-compose up -d
```

```bash
# Unix/macOS/Linux
./gradlew :app:bootRun --args='--spring.profiles.active=docker'
```

```shell
# Windows
.\gradlew.bat :app:bootRun --args="--spring.profiles.active=docker"
```

* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `localhost:5432`
* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é):
  * DB_HOST=`localhost`
  * DB_PORT=`5432`
  * DB_NAME=`ratelimiter`
  * DB_USER=`postgres`
  * DB_PASSWORD=`postgres`

## üìû –í—ã–∑–æ–≤ API

* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```bash
curl -X POST "http://localhost:8080/api/register" \
  -H "Content-Type: application/json" \
  -d '{"name": "MyAwesomeClient"}'
```

* –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞

```bash
curl -X POST "http://localhost:8080/api/words" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: e8884ad9-b7d3-41a1-a4cc-562805621517" \
  -d '{"text": "Some Text"}'
```

> –ó–∞–º–µ–Ω–∏—Ç—å `X-API-Key` –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ `/api/register`

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

* `./gradlew build` ‚Äî —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –º–æ–¥—É–ª–∏
* `./gradlew clean` ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
* `./gradlew clean build` ‚Äî —É–¥–∞–ª–∏—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –∑–∞–Ω–æ–≤–æ
* `./gradlew :app:bootRun` ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
* `./gradlew :app:bootRun --args='--debug'` ‚Äî –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏
* `docker-compose up -d` ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
* `docker-compose down` ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

* `./gradlew test` ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
* `./gradlew :persistence:test` ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª—è persistence
* `./gradlew :app:test --tests "com.example.e2e.RegisterClientTest"` ‚Äî 
–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã


